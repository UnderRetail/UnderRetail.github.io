<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - UnderRetail</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Firebase Configuration -->
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDuOUYMmOqQxkiSn2kAonP6l2eqnzWOwYU",
        authDomain: "underretail-5faa1.firebaseapp.com",
        projectId: "underretail-5faa1",
        storageBucket: "underretail-5faa1.firebasestorage.app",
        messagingSenderId: "23710024924",
        appId: "1:23710024924:web:4a54122221372487c42019"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    </script>

    <!-- Header -->
    <header>
        <div class="container">
            <nav>
                <a href="index.html" class="logo">UNDERRETAIL</a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="#" id="adminLogoutBtn" class="btn-outline">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Admin Dashboard -->
    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1>Admin Dashboard <span class="live-badge">LIVE</span></h1>
                <div class="admin-info">
                    <span>Welcome, <strong>Administrator</strong></span>
                    <span class="last-login">Last updated: <span id="lastUpdate">Just now</span></span>
                </div>
            </div>

            <!-- Real-time Stats -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Total Applications</h3>
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="card-value" id="totalApplications">0</div>
                    <div class="card-change" id="applicationsChange">
                        <i class="fas fa-sync"></i> Live from Firebase
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Application Capital</h3>
                        <i class="fas fa-pound-sign"></i>
                    </div>
                    <div class="card-value" id="totalCapital">¬£0</div>
                    <div class="card-change" id="capitalChange">
                        <i class="fas fa-sync"></i> Real-time total
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Pending Review</h3>
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="card-value" id="pendingApplications">0</div>
                    <div class="card-change">
                        Need your attention
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Contact Messages</h3>
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="card-value" id="totalContacts">0</div>
                    <div class="card-change">
                        <i class="fas fa-sync"></i> Live inbox
                    </div>
                </div>
            </div>

            <!-- Recent Applications (Real Data) -->
            <div class="dashboard-section">
                <h2>Live Applications <span class="badge" id="recentCount">0</span></h2>
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Tier</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTable">
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-gray);">
                                    <i class="fas fa-sync fa-spin"></i> Loading live applications...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tier Distribution (Real Data) -->
            <div class="dashboard-section">
                <h2>Application Tier Distribution</h2>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Bronze Tier</h3>
                            <span class="tier-badge tier-bronze">Bronze</span>
                        </div>
                        <div class="card-value" id="bronzeCount">0</div>
                        <div class="card-value" id="bronzeAmount">¬£0</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Silver Tier</h3>
                            <span class="tier-badge tier-silver">Silver</span>
                        </div>
                        <div class="card-value" id="silverCount">0</div>
                        <div class="card-value" id="silverAmount">¬£0</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Gold Tier</h3>
                            <span class="tier-badge tier-gold">Gold</span>
                        </div>
                        <div class="card-value" id="goldCount">0</div>
                        <div class="card-value" id="goldAmount">¬£0</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>VIP Tier</h3>
                            <span class="tier-badge tier-vip">VIP</span>
                        </div>
                        <div class="card-value" id="vipCount">0</div>
                        <div class="card-value" id="vipAmount">¬£0</div>
                    </div>
                </div>
            </div>

            <!-- Recent Contacts (Real Data) -->
            <div class="dashboard-section">
                <h2>Recent Contact Messages</h2>
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Subject</th>
                                <th>Message</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-gray);">
                                    <i class="fas fa-sync fa-spin"></i> Loading messages...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Your Existing Sections (Keep them) -->
            <div class="dashboard-section">
                <h2>Business Performance</h2>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Monthly Revenue</h3>
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="card-value">¬£425,000</div>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>Investor Growth</h3>
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="card-value">+24</div>
                        <div class="chart-container">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keep your existing investor management, payout management, etc. -->

        </div>
    </section>

    <!-- Real-time Firebase Script -->
    <script>
    // Real-time data listeners
    let applications = [];
    let contacts = [];

    // Listen for new applications
    db.collection('applications')
        .orderBy('timestamp', 'desc')
        .onSnapshot((snapshot) => {
            applications = [];
            snapshot.forEach(doc => {
                applications.push({ id: doc.id, ...doc.data() });
            });
            updateApplicationsDashboard();
        });

    // Listen for new contacts
    db.collection('contacts')
        .orderBy('timestamp', 'desc')
        .onSnapshot((snapshot) => {
            contacts = [];
            snapshot.forEach(doc => {
                contacts.push({ id: doc.id, ...doc.data() });
            });
            updateContactsDashboard();
        });

    function updateApplicationsDashboard() {
        // Update counters
        document.getElementById('totalApplications').textContent = applications.length;
        document.getElementById('pendingApplications').textContent = applications.filter(app => app.status === 'under_review').length;
        document.getElementById('recentCount').textContent = applications.length;

        // Calculate total capital
        const totalCapital = applications.reduce((sum, app) => sum + (app.amount || 0), 0);
        document.getElementById('totalCapital').textContent = `¬£${totalCapital}`;

        // Update tier distribution
        const bronzeApps = applications.filter(app => app.tier === 'bronze');
        const silverApps = applications.filter(app => app.tier === 'silver');
        const goldApps = applications.filter(app => app.tier === 'gold');
        const vipApps = applications.filter(app => app.tier === 'vip');

        document.getElementById('bronzeCount').textContent = bronzeApps.length;
        document.getElementById('bronzeAmount').textContent = `¬£${bronzeApps.reduce((sum, app) => sum + (app.amount || 0), 0)}`;
        
        document.getElementById('silverCount').textContent = silverApps.length;
        document.getElementById('silverAmount').textContent = `¬£${silverApps.reduce((sum, app) => sum + (app.amount || 0), 0)}`;
        
        document.getElementById('goldCount').textContent = goldApps.length;
        document.getElementById('goldAmount').textContent = `¬£${goldApps.reduce((sum, app) => sum + (app.amount || 0), 0)}`;
        
        document.getElementById('vipCount').textContent = vipApps.length;
        document.getElementById('vipAmount').textContent = `¬£${vipApps.reduce((sum, app) => sum + (app.amount || 0), 0)}`;

        // Update applications table
        const tbody = document.getElementById('applicationsTable');
        tbody.innerHTML = applications.slice(0, 10).map(app => `
            <tr>
                <td>${new Date(app.timestamp?.toDate()).toLocaleDateString()}</td>
                <td><strong>${app.name}</strong></td>
                <td>${app.email}</td>
                <td><span class="tier-badge tier-${app.tier}">${app.tier}</span></td>
                <td>¬£${app.amount}</td>
                <td><span class="status-badge status-${app.status}">${app.status.replace('_', ' ')}</span></td>
                <td>
                    <button class="btn-small" onclick="viewApplication('${app.id}')">View</button>
                    <button class="btn-small btn-outline" onclick="updateStatus('${app.id}', 'approved')">Approve</button>
                </td>
            </tr>
        `).join('') || '<tr><td colspan="7" style="text-align: center; color: var(--text-gray);">No applications yet</td></tr>';

        updateTimestamp();
    }

    function updateContactsDashboard() {
        document.getElementById('totalContacts').textContent = contacts.length;
        
        const tbody = document.getElementById('contactsTable');
        tbody.innerHTML = contacts.slice(0, 10).map(contact => `
            <tr>
                <td>${new Date(contact.timestamp?.toDate()).toLocaleDateString()}</td>
                <td><strong>${contact.name}</strong></td>
                <td>${contact.email}</td>
                <td>${contact.subject}</td>
                <td>${contact.message.substring(0, 50)}${contact.message.length > 50 ? '...' : ''}</td>
                <td><span class="status-badge status-${contact.status}">${contact.status}</span></td>
            </tr>
        `).join('') || '<tr><td colspan="6" style="text-align: center; color: var(--text-gray);">No messages yet</td></tr>';

        updateTimestamp();
    }

    function updateTimestamp() {
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }

    function viewApplication(appId) {
        const app = applications.find(a => a.id === appId);
        if (app) {
            alert(`üìã Application Details:\n\nüë§ Name: ${app.name}\nüìß Email: ${app.email}\nüìû Phone: ${app.phone}\nüéØ Tier: ${app.tier}\nüí∞ Amount: ¬£${app.amount}\nüìä Status: ${app.status}\nüìÖ Applied: ${new Date(app.timestamp?.toDate()).toLocaleString()}`);
        }
    }

    function updateStatus(appId, newStatus) {
        db.collection('applications').doc(appId).update({
            status: newStatus
        }).then(() => {
            alert('‚úÖ Application status updated!');
        }).catch(error => {
            alert('‚ùå Error updating status: ' + error.message);
        });
    }

    // Your existing functionality
    document.getElementById('adminLogoutBtn').addEventListener('click', function() {
        localStorage.removeItem('adminLoggedIn');
        window.location.href = 'admin-login.html';
    });

    // Initialize your existing charts
    document.addEventListener('DOMContentLoaded', function() {
        // Your existing chart code here...
    });

    console.log("üî• Admin dashboard loaded - watching for REAL-TIME data!");
    </script>

    <style>
    .live-badge {
        background: #4CAF50;
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        margin-left: 10px;
        animation: pulse 2s infinite;
    }
    
    .badge {
        background: var(--gold);
        color: var(--black);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        margin-left: 10px;
    }
    
    .status-under_review {
        background: rgba(255, 193, 7, 0.2);
        color: #FFC107;
    }
    
    .status-approved {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
    }
    
    .status-new {
        background: rgba(33, 150, 243, 0.2);
        color: #2196F3;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    </style>
</body>
</html>
